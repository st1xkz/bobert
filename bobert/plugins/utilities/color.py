import asyncio
import io

import hikari
import lightbulb
from PIL import Image

color = lightbulb.Plugin("color")


@color.command
@lightbulb.add_cooldown(10, 3, lightbulb.UserBucket)
@lightbulb.option(
    name="hex_code",
    description="the hex code to the specified color",
    required=True,
    modifier=lightbulb.OptionModifier.CONSUME_REST,
)
@lightbulb.command(
    name="color",
    description="Displays a color using the provided hex code (you can add up to 10)",
    pass_options=True,
)
@lightbulb.implements(lightbulb.SlashCommand)
async def get_color(ctx: lightbulb.Context, hex_code: str) -> None:
    color_codes = hex_code.split()
    size = (60, 80) if len(color_codes) > 1 else (200, 200)

    if len(color_codes) > 10:
        return await ctx.respond(
            "You can only supply a maximum of **10** hex codes.",
            flags=hikari.MessageFlag.EPHEMERAL,
        )

    for color_code in color_codes:
        if not color_code.startswith("#"):
            colour_code = "#" + color_code
            image = Image.new("RGB", size, colour_code)
            buf = io.BytesIO()

            with buf as file:
                image.save(file, "PNG")
                file.seek(0)

                embed = hikari.Embed(
                    title=f"Color `{colour_code}`",
                    color=0x2F3136,
                )
                embed.set_image(hikari.Bytes(file, "Color.png"))
                await ctx.respond(embed=embed)
            await asyncio.sleep(1)
        else:
            await ctx.respond(
                "❌ Please make sure the color generated by the hex code is correct and that a `#` does not appear before it.",
                flags=hikari.MessageFlag.EPHEMERAL,
            )


def load(bot: lightbulb.BotApp) -> None:
    bot.add_plugin(color)


def unload(bot: lightbulb.BotApp) -> None:
    bot.remove_plugin(color)
